# This file was generated by ansible
# DO NOT modify this file by hand

#################### INTERFACE DEFINITIONS ####################
extif="vmx0"
intif="vmx1"
dmz_insecureif="vmx2"
vpn_home2vps="tun1"
vpn_warrior="tun0"
guestif="em0"
vps="192.168.255.1"
# for further HA with CARP
ext_vip="vmx0"
dmz_insecure_vip="vmx2"

#################### MACROS & TABLES ####################
orange_lan_net="172.31.3.0/24"
host_http_public_redirected="172.31.1.47"
host_https_public_redirected="172.31.1.47"
host_ssh_public_redirected="172.31.1.37"
host_kms_public_redirected="172.31.200.100"
bignas_openvpn_public_redirected="172.31.1.200"

smb_tcp = "{ netbios-ns, netbios-dgm , netbios-ssn ,  microsoft-ds }"
smb_udp = "{ netbios-ns, netbios-dgm , netbios-ssn ,  microsoft-ds }"
tproxy_port = 3129
proxy_port = 3128

table <BLOCKEDIP> persist {}
table <SSHGUARD> persist {}
table <FAIL2BAN> persist {}
table <BRUTEFORCESSH> persist {}
table <PRIVATE_IP> { 10.0.0.0/8 , 172.16.0.0/12 , 192.168.0.0/16 }
table <ALLOW_TO_FTP_INTERNET>  { 172.31.1.0/24 }
table <ALLOW_TO_HTTP_INTERNET> { 172.31.1.0/24 , 172.30.0.13/32 , 172.30.0.10/32 , 172.31.4.0/24 }
table <ALLOW_TO_HTTPS_INTERNET> { 172.31.1.0/24 , 172.30.0.13/32 , 172.30.0.10/32 , 172.31.4.0/24 }
table <ALLOW_TO_FW_DNS> { 10.99.2.0/24 , 172.30.0.0/16 , 172.31.0.0/16 }
table <ALLOW_TO_FW_SSH> { 172.31.2.0/24 , 172.31.1.0/24 }
table <ALLOW_TO_FW_SAMBA> { 172.31.2.0/24 , 172.31.1.0/24 }
table <ALLOW_TO_FW_TFTP> { 172.31.1.0/24 , 172.30.0.0/16 , 172.31.2.0/24 , 172.31.4.0/24 }
table <ALLOW_TO_FW_PROXY> { 172.30.0.0/24, 172.31.1.0/24 ,172.31.2.32/28 ,172.31.2.48/28}
table <ALLOW_TO_ANY_INTERNET> {172.31.1.0/24 }
table <ALLOW_TO_ORANGE_NET> { 172.30.0.0/24, 172.31.2.0/24 , 172.31.1.0/24 }
table <FR_IP_RANGE>  persist file "/etc/pf_tables/pf.table.fr_ip_range"
table <TRUSTED_PUBLIC_IP>  persist file "/etc/pf_tables/pf.table.trusted_public_ip"
table <ALLOW_TO_TPROXY>  { }
table <EXCLUDED_TO_TPROXY> { 172.31.1.0/24,  172.31.1.201/32 , 172.31.1.34/32 , 172.31.1.235/32 }
table <VPN_WARRIOR> { 172.31.2.64/26 }

#################### GLOBAL OPTIONS ####################
set skip on lo
#set skip on $firewall_loopback
#match in all scrub (no-df)


#################### NAT/REDIRECT rules ####################
match out on $extif inet all tagged TO_INTERNET nat-to $ext_vip
match out on $extif inet all tagged TO_ORANGE_LAN nat-to  $ext_vip
match out on $dmz_insecureif inet all tagged TO_DMZ_INSECURE nat-to $dmz_insecure_vip
match out on $dmz_insecureif inet all tagged PORT_REDIRECTED nat-to $dmz_insecure_vip

pass in quick on $extif inet proto tcp from any to $ext_vip port = http tag PORT_REDIRECTED rdr-to $host_http_public_redirected port 80
pass in quick on $extif inet proto tcp from any to $ext_vip port = https tag PORT_REDIRECTED rdr-to $host_https_public_redirected port 443
pass in quick on $extif inet proto tcp from any to $ext_vip port = 1688 tag PORT_REDIRECTED rdr-to $host_kms_public_redirected port 1688
pass in quick on $extif inet proto udp from any to $ext_vip port = 1192 tag PORT_REDIRECTED rdr-to $bignas_openvpn_public_redirected port 1193

pass in quick on $intif inet proto tcp from <ALLOW_TO_FTP_INTERNET> to !<PRIVATE_IP> port = ftp tag ACCESS_PROXY_TRANSPARENT divert-to 127.0.0.1 port 8021

pass in quick on $dmz_insecureif inet proto tcp from $dmz_insecureif:network to 172.31.1.200 port = ftp divert-to 127.0.0.1 port 8021
# disabled for now, as transparent proxy not currently used
#no rdr on $intif inet proto tcp from <EXCLUDED_TO_TPROXY> to !<PRIVATE_IP> port = http
#rdr on $intif inet proto tcp from <ALLOW_TO_TPROXY> to !<PRIVATE_IP> port = http tag ACCESS_PROXY_TRANSPARENT  -> 127.0.0.1 port $tproxy_port

#################### FILTERING RULES ####################
#### antispoof ####
antispoof quick for { lo $intif $dmz_insecureif }


#### default policy ####
set block-policy drop

# block specific thing that should be allowed above
block quick on $extif from <SSHGUARD>
block quick on $extif from <FAIL2BAN>
block quick on $extif from <BRUTEFORCESSH>
block quick log on $extif from <BLOCKEDIP>
block quick log from any to <BLOCKEDIP>

#carp protocol for HA
pass quick inet proto carp keep state label CARP_RULE

# for ftp proxy helper
anchor "ftp-proxy/*"

#### VPN interfaces ####
pass quick on $vpn_home2vps tagged TO_VPN_HOME2VPS
pass quick on $vpn_warrior from any to any tag VPN_WARRIOR

#### Firewall access inbound ####
#### any interface
pass in quick inet proto {udp,tcp} from <ALLOW_TO_FW_DNS> to self port 53 keep state (no-sync) label TO_FW_DNS

pass in quick inet proto udp from any to self port  123 keep state (no-sync) label TO_FW_NTP

pass in quick inet proto icmp from any to self icmp-type echoreq keep state (no-sync) label TO_FW_PING

## external interface
pass in quick on $extif inet proto udp from <FR_IP_RANGE> to $extif:0 port 1193 keep state (no-sync) label TO_FW_OPENPN
pass in quick on $extif inet proto udp from  <TRUSTED_PUBLIC_IP> to $extif:0 port 1193 keep state (no-sync) label TO_FW_OPENVPN

pass in quick on $extif from <FR_IP_RANGE> tagged PORT_REDIRECTED label ALLOWED_BY_TAG
pass in quick on $extif from <TRUSTED_PUBLIC_IP> tagged PORT_REDIRECTED label ALLOWED_BY_TAG

pass in quick on $extif inet proto icmp all icmp-type unreach  keep state

## internal interface
pass in quick on $intif inet proto udp from any to $intif:0 port 67 keep state (no-sync) label TO_FW_DHCP
pass in quick on $intif inet proto udp from any to $intif:broadcast port 67 keep state (no-sync) label TO_FW_DHCP
pass in quick on $intif inet proto udp from <ALLOW_TO_FW_TFTP> to $intif:0 port 69 keep state (no-sync) label TO_FW_TFTP

pass in quick on $intif inet proto tcp from <ALLOW_TO_FW_SAMBA> to $intif:0 port $smb_tcp keep state (no-sync) label TO_FW_SAMBA
pass in quick on $intif inet proto udp from <ALLOW_TO_FW_SAMBA> to $intif:0 port $smb_udp keep state (no-sync) label TO_FW_SAMBA
pass in quick on $intif inet proto udp from <ALLOW_TO_FW_SAMBA> to $intif:broadcast port $smb_udp keep state (no-sync) label TO_FW_SAMBA

pass in quick on $intif inet proto tcp from <ALLOW_TO_FW_SSH> to $intif:0 port 22 keep state (no-sync) label TO_FW_SSH

pass in quick on $intif inet proto tcp from 172.31.1.0/24 to $intif:0 port 8888 keep state (no-sync)
#pass in quick on $intif inet proto tcp from <ALLOW_TO_FW_PROXY> to $intif:0 port proxy_port (no-sync) label TO_FW_PROXY
#pass in quick on $intif tagged ACCESS_PROXY_TRANSPARENT

#### dmz_insecure interface
pass in quick on $dmz_insecureif inet proto udp from any to $dmz_insecureif:0 port 67 keep state (no-sync) label TO_FW_DHCP
block return in quick on $dmz_insecureif

#### guest interface
#pass in quick on $guestif from  $guestif:network to 

#enforce explicit deny to prevent passing rules later
block log quick from any to self label DENY_TO_FW


###### Packets forwarded by firewall
## external interface
pass out quick on $extif tagged TO_INTERNET keep state label ALLOWED_BY_TAG
pass out quick on $extif tagged TO_ORANGE_LAN keep state label ALLOWED_BY_TAG


## internal interface
pass out quick on $intif tagged VPN_OUTBOUND

pass in quick on $intif from <ALLOW_TO_ORANGE_NET> to $orange_lan_net tag TO_ORANGE_LAN label ALLOW_TO_ORANGE_NET

pass in quick on $intif to $dmz_insecureif:network tag TO_DMZ_INSECURE


pass in quick on $intif from 172.31.1.0/24 to 192.168.255.1 tag TO_VPN_HOME2VPS
pass in quick on $intif from 172.31.1.0/24 to <VPN_WARRIOR> tag TO_VPN_WARRIOR

##  dmz_insecure interface
pass out quick on $dmz_insecureif tagged TO_DMZ_INSECURE

pass out quick on $dmz_insecureif inet proto udp from $dmz_insecureif:0 to any port 67 keep state (no-sync) label TO_FW_DHCP


## any interface
pass out quick tagged PORT_REDIRECTED label ALLOWED_BY_TAG

pass in quick inet proto tcp from <ALLOW_TO_ANY_INTERNET> to !<PRIVATE_IP> tag TO_INTERNET label ALLOW_TO_ANY_INTERNET
pass in quick inet proto udp from <ALLOW_TO_ANY_INTERNET> to !<PRIVATE_IP> tag TO_INTERNET label ALLOW_TO_ANY_INTERNET
pass in quick inet proto icmp from <ALLOW_TO_ANY_INTERNET> to !<PRIVATE_IP> icmp-type echoreq tag TO_INTERNET label ALLOW_TO_ANY_INTERNET

pass in quick inet proto tcp from <ALLOW_TO_HTTP_INTERNET> to !<PRIVATE_IP> port 80 tag TO_INTERNET label TO_HTTP_INTERNET
pass in quick inet proto tcp from <ALLOW_TO_HTTPS_INTERNET> to !<PRIVATE_IP> port 443 tag TO_INTERNET label TO_HTTPS_INTERNET


#### Fw access outbound ####
pass out quick on $extif inet proto tcp from $intif:0 to ! <PRIVATE_IP> user _tinyproxy route-to ( $vpn_home2vps $vps ) tag TO_VPN_HOME2VPS
#fw has full access to everywhere
#pass out quick on $extif from $extif:0 to any keep state (no-sync) label FW_OUTBOUND
#pass out quick on $intif from $intif:0 to any keep state (no-sync) label FW_OUTBOUND
#pass out quick on $dmz_insecureif from $dmz_insecureif:0 to any keep state (no-sync) label FW_OUTBOUND
pass out quick from self to any label FW_OUTBOUND 
pass out quick tagged VPN_WARRIOR

# some specific block with NO log
block quick inet6 label DENY_IPV6
block quick on $extif inet proto udp from any to 239.255.255.250  port 1900 label  DENY_UPNP_WAN
block quick on $extif inet proto igmp from any to 239.255.255.250 label DENY_IGMP_WAN
block quick on $extif inet proto igmp from any to 224.0.0.1 label DENY_IGMP_WAN
block quick inet proto icmp from any to 224.0.0.1 label DENY


# block log (to pflogd) all to troubleshoot
block drop log quick all
#
